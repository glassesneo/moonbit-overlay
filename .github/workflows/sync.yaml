name: Prefetch MoonBit
on:
  schedule:
    - cron: '0 2 * * *' # *-*-* 02:00:00 UTC

  workflow_dispatch:

  push:
    branches:
      - master
    paths:
      - .github/workflows/sync.yaml
      - scripts/fetch_toolchains.sh
      - lib/moon-patched/update.sh

permissions:
  contents: write

jobs:
  prefetch-moonbit:
    name: Prefetch MoonBit
    runs-on: ubuntu-latest
    outputs:
      skipped: ${{ steps.fetch_toolchains.outputs.skipped }}
      version: ${{ steps.fetch_toolchains.outputs.version }}
      moon_revision: ${{ steps.fetch_toolchains.outputs.moon_revision }}

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Install Nix
      uses: nixbuild/nix-quick-install-action@v30

    - uses: nix-community/cache-nix-action@v6
      with:
        primary-key: build-${{ runner.os }}-${{ hashFiles('**/*.nix', '**/flake.lock') }}
        restore-prefixes-first-match: build-${{ runner.os }}-
        gc-max-store-size-linux: 1G
        purge: true
        purge-prefixes: build-${{ runner.os }}-
        purge-created: 0
        purge-primary-key: never

    - name: Prefetch latest MoonBit
      id: fetch_toolchains
      timeout-minutes: 10
      run: ./scripts/fetch_toolchains.sh

    - name: Prefetch latest Moon Patched Deps
      if: steps.fetch_toolchains.outputs.skipped != 'true'
      timeout-minutes: 10
      run: ./lib/moon-patched/update.sh
      env:
        REVISION: ${{ steps.fetch_toolchains.outputs.moon_revision }}

    - name: Upload candidate workspace
      if: steps.fetch_toolchains.outputs.skipped != 'true'
      uses: actions/upload-artifact@v4
      with:
        name: candidate-workspace
        path: |
          versions/
          lib/moon-patched/deps_versions.json

  smoke-test:
    name: Smoke test (${{ matrix.os }})
    needs: prefetch-moonbit
    if: needs.prefetch-moonbit.outputs.skipped != 'true'
    strategy:
      fail-fast: true
      matrix:
        os: [ubuntu-latest, macos-14]
    runs-on: ${{ matrix.os }}

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Install Nix
      uses: nixbuild/nix-quick-install-action@v30

    - name: Download candidate workspace
      uses: actions/download-artifact@v4
      with:
        name: candidate-workspace

    - name: Log candidate version
      run: |
        candidate_version=$(jq -r '.version' versions/toolchains/latest.json)
        echo "Candidate version: $candidate_version"
        echo "candidate_version=$candidate_version" >> "$GITHUB_ENV"

    - name: Build moonbit_latest
      timeout-minutes: 20
      run: nix build .#moonbit_latest

    - name: Smoke test moonbit_latest
      timeout-minutes: 10
      run: nix shell .#moonbit_latest -c bash ./scripts/smoke-moonbit-latest.sh

    - name: Verify tested version matches candidate
      run: |
        tested_version=$(nix shell .#moonbit_latest -c moonc -v 2>&1 | awk '{print $1}')
        echo "Tested version output: $tested_version"
        echo "Candidate version: $candidate_version"
        if [[ "$tested_version" != *"$candidate_version"* ]] && [[ "$candidate_version" != *"$tested_version"* ]]; then
          echo "WARNING: version mismatch, but proceeding (version format may differ)"
        fi

  publish:
    name: Commit & Release
    needs: [prefetch-moonbit, smoke-test]
    if: needs.prefetch-moonbit.outputs.skipped != 'true'
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Download candidate workspace
      uses: actions/download-artifact@v4
      with:
        name: candidate-workspace

    - name: Check and commit changes (versions)
      id: commit_version
      continue-on-error: true
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add versions
        git add lib/moon-patched/deps_versions.json
        git commit -m "versions: update"

    - name: Push version changes
      if: steps.commit_version.outcome == 'success'
      uses: ad-m/github-push-action@master
      with:
        branch: ${{ github.ref }}
        github_token: ${{ secrets.GITHUB_TOKEN }}

    - name: Check if tag exists
      id: check_tag
      if: steps.commit_version.outcome == 'success'
      run: |
        TAG="${{ needs.prefetch-moonbit.outputs.version }}"
        if git fetch --tags && git tag | grep -q "^$TAG$"; then
          echo "exists=true" >> $GITHUB_OUTPUT
        else
          echo "exists=false" >> $GITHUB_OUTPUT
        fi

    - name: Release new version
      if: steps.commit_version.outcome == 'success' && steps.check_tag.outputs.exists == 'false'
      uses: ncipollo/release-action@v1
      with:
        tag: ${{ needs.prefetch-moonbit.outputs.version }}
        immutableCreate: true
        body: "New version ${{ needs.prefetch-moonbit.outputs.version }} fetched from MoonBit."
        artifacts: "moonbit-linux-x86_64.tar.gz, moonbit-darwin-aarch64.tar.gz, moonbit-core.tar.gz"
